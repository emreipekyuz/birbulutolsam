/**
 * Bu fonksiyon, web uygulamasına bir GET isteği geldiğinde çalışır.
 * Etkinlik listesini çekmek için kullanılır.
 */
function doGet(e) {
  var response;
  try {
    if (e.parameter.action == 'getEtkinlikler') {
      var etkinlikler = getEtkinliklerData();
      response = { success: true, data: etkinlikler };
    } else {
      response = { success: true, message: 'API çalışıyor.' };
    }
  } catch (error) {
    response = { success: false, message: error.message };
  }
  
  // DÜZELTME: Her cevaba CORS izni ekleniyor.
  return ContentService.createTextOutput(JSON.stringify(response))
    .setMimeType(ContentService.MimeType.JSON)
    .addHttpHeader("Access-Control-Allow-Origin", "*");
}

/**
 * Bu fonksiyon, web uygulamasına bir POST isteği geldiğinde çalışır.
 * Yeni kayıt eklemek veya mevcut kullanıcıyı bulmak için kullanılır.
 */
function doPost(e) {
  var response;
  try {
    var requestData = JSON.parse(e.postData.contents);
    var action = requestData.action;

    if (action === 'kullaniciyiBul') {
      var kullanici = kullaniciyiBulData(requestData.telefon);
      response = { success: true, data: kullanici };
    } else if (action === 'kayitEkle') {
      var sonuc = kayitEkleData(requestData.formData);
      response = { success: true, message: sonuc };
    } else {
      throw new Error('Geçersiz eylem belirtildi.');
    }
  } catch (error) {
    response = { success: false, message: error.message };
  }

  // DÜZELTME: Her cevaba CORS izni ekleniyor.
  return ContentService.createTextOutput(JSON.stringify(response))
    .setMimeType(ContentService.MimeType.JSON)
    .addHttpHeader("Access-Control-Allow-Origin", "*");
}

// YARDIMCI FONKSİYONLARIN İSİMLERİ KARIŞIKLIĞI ÖNLEMEK İÇİN DEĞİŞTİRİLDİ

function getEtkinliklerData() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Etkinlikler');
  if (!sheet) throw new Error("Sunucu tarafında 'Etkinlikler' sayfası bulunamadı.");
  var data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 2).getValues();
  return data.filter(row => row[0] !== '');
}

function kullaniciyiBulData(telefon) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Kayıtlar');
  if (!sheet) throw new Error("Sunucu tarafında 'Kayıtlar' sayfası bulunamadı.");
  
  var data = sheet.getDataRange().getValues();
  for (var i = data.length - 1; i >= 1; i--) {
    if (String(data[i][5]) === String(telefon)) {
      return {
        ad: data[i][2],
        soyad: data[i][3],
        email: data[i][4],
        telefon: data[i][5],
        universite: data[i][7] || '',
        bolum: data[i][8] || ''
      };
    }
  }
  return null;
}

function kayitEkleData(formData) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Kayıtlar');
  if (!sheet) throw new Error("Sunucu tarafında 'Kayıtlar' sayfası bulunamadı.");
  
  sheet.appendRow([
    new Date(),
    formData.etkinlik,
    formData.ad,
    formData.soyad,
    formData.email,
    formData.telefon,
    'Evet',
    formData.universite,
    formData.bolum
  ]);
  return "Harika! Kaydını aldık. Etkinlikte görüşmek üzere!";
}
