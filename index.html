<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
      :root {
        --primary-gradient: linear-gradient(90deg, #f77062 0%, #fe5196 100%);
        --text-dark: #333;
      }
      
      @keyframes gradient-animation {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }

      body {
        font-family: 'Poppins', sans-serif;
        background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
        background-size: 400% 400%;
        animation: gradient-animation 15s ease infinite;
        color: var(--text-dark);
        padding-top: 2rem;
        padding-bottom: 2rem;
      }

      .form-card {
        background: rgba(255, 255, 255, 0.85);
        border: none;
        border-radius: 20px;
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      }

      .form-control, .form-select {
        background-color: rgba(255, 255, 255, 0.5);
        border: 1px solid rgba(0,0,0,0.1);
        color: var(--text-dark);
        border-radius: 10px;
      }
      .form-control:focus, .form-select:focus {
        background-color: #fff;
        border-color: #fe5196;
        box-shadow: 0 0 0 0.25rem rgba(254, 81, 150, 0.25);
        color: var(--text-dark);
      }
      .form-select option { background-color: #fff; color: var(--text-dark); }
      .form-check-input:checked { background-color: #e73c7e; border-color: #e73c7e; }

      .btn-primary {
        background: var(--primary-gradient);
        border: none;
        padding: 0.8rem;
        border-radius: 10px;
        font-weight: 700;
        color: white;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(231, 60, 126, 0.4);
      }
      
      #mevcutKullaniciToggle { cursor: pointer; color: #e73c7e; font-weight: 500;}
      #kvkkLink { cursor: pointer; text-decoration: underline; }
      #mevcutKullaniciAlan { display: none; }
    </style>
</head>
<body>
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
          <div class="form-card">
            <div class="card-body p-4 p-sm-5">
              <h2 class="card-title text-center fw-bold mb-3">☁️ Bir Bulut Olsam</h2>
              <p class="text-center text-secondary mb-4">Etkinlik Kayıt Formu</p>
              
              <div class="text-center mb-3">
                <a id="mevcutKullaniciToggle">Daha önce kaydoldum, bilgilerimi getir.</a>
              </div>
              <div id="mevcutKullaniciAlan" class="mb-3">
                <div class="input-group">
                  <span class="input-group-text">+90</span>
                  <input type="tel" class="form-control" id="telefonGetir" placeholder="Telefon numaran" pattern="[5][0-9]{9}" title="Lütfen 10 haneli telefon numaranızı girin (örn: 5551234567)">
                  <button class="btn btn-outline-secondary" type="button" id="bilgiGetirBtn">Getir</button>
                </div>
              </div>
              <hr id="formSeparator" style="display:none;">
              
              <form id="kayitFormu">
                <select id="etkinlik" class="form-select mb-3" required><option value="">Katılmak istediğin etkinliği seç...</option></select>
                <input type="text" class="form-control mb-3" id="ad" placeholder="Adın" required>
                <input type="text" class="form-control mb-3" id="soyad" placeholder="Soyadın" required>
                <input type="email" class="form-control mb-3" id="email" placeholder="E-posta adresin" required>
                
                <div class="input-group mb-3">
                  <span class="input-group-text">+90</span>
                  <input type="tel" class="form-control" id="telefon" placeholder="Telefon numaran" required pattern="[5][0-9]{9}" title="Lütfen 10 haneli telefon numaranızı girin (örn: 5551234567)">
                </div>
                
                <div class="form-check mb-4">
                  <input type="checkbox" class="form-check-input" id="kvkk" required>
                  <label class="form-check-label" for="kvkk" style="font-size: 0.8rem;">
                    <a id="kvkkLink" data-bs-toggle="modal" data-bs-target="#kvkkModal">KVKK aydınlatma metnini</a> okudum, anladım ve kabul ediyorum.
                  </label>
                </div>
                
                <div class="d-grid">
                  <button type="submit" class="btn btn-primary btn-lg">KAYIT OL</button>
                </div>
              </form>
              <div id="status" class="mt-3"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="kvkkModal" tabindex="-1" aria-labelledby="kvkkModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="kvkkModalLabel">BİR BULUT OLSAM DERNEĞİ ETKİNLİKLERİ</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <h6>KİŞİSEL VERİLERİN KORUNMASI KANUNU KAPSAMINDA AYDINLATMA METNİ</h6>
            <p>Bir Bulut Olsam Derneği ("Dernek") olarak, veri sorumlusu sıfatıyla, düzenlediğimiz etkinliklere katılımınız sırasında sizlerden elde edilen kişisel verilerinize büyük önem veriyoruz. Kişisel verilerinizin 6698 sayılı Kişisel Verilerin Korunması Kanunu ("KVKK") uyarınca işlenmesi ve korunması süreçlerinde şeffaflığı sağlamak amacıyla bu aydınlatma metnini bilgilerinize sunuyoruz.</p>
            <h6>1. Veri Sorumlusunun Kimliği</h6>
            <p>KVKK uyarınca kişisel verileriniz, veri sorumlusu olarak aşağıda bilgileri sunulan Bir Bulut Olsam Derneği tarafından işlenecektir.</p>
            <p><strong>Derneğin Adı:</strong> Bir Bulut Olsam Derneği<br><strong>Adres:</strong> Karaman Mahallesi, Tuna Caddesi, Fulya Sokak, No:1, Nilüfer/Bursa<br><strong>Telefon:</strong> 0555 156 07 33<br><strong>E-posta:</strong> birbulutolsamdernegi@gmail.com<br><strong>Web Sitesi:</strong> Bulunmamaktadır.</p>
            <h6>2. Kişisel Verilerin İşlenme Amaçları</h6>
            <p>Etkinliklerimize katılımınızla bağlantılı olarak toplanan kişisel verileriniz, aşağıda belirtilen amaçlarla sınırlı olarak işlenmektedir:</p>
            <ul>
                <li><strong>Etkinlik Yönetimi:</strong> Etkinlik kayıtlarının oluşturulması, katılımcı listelerinin hazırlanması, yaka kartlarının basılması ve etkinliğin sorunsuz bir şekilde yürütülmesi.</li>
                <li><strong>İletişim:</strong> Etkinlik öncesi bilgilendirme, hatırlatma, yer ve zaman değişikliği gibi konularda sizinle iletişime geçilmesi; etkinlik sonrası teşekkür ve değerlendirme anketlerinin gönderilmesi.</li>
                <li><strong>Tanıtım ve Kamuoyu Bilgilendirmesi:</strong> Etkinlik sırasında çekilen fotoğraf ve video kayıtlarının, Derneğin faaliyetlerini tanıtmak, kamuoyunu bilgilendirmek ve arşiv oluşturmak amacıyla Derneğin sosyal medya hesapları (Instagram, Facebook, Twitter, vb.), bültenler ve diğer basılı/dijital yayın organlarında paylaşılması.</li>
                <li><strong>Yasal Yükümlülükler:</strong> Dernekler mevzuatı ve diğer ilgili kanunlar uyarınca resmi kurumlara (örneğin mülki idare amirlikleri) yapılması gereken zorunlu bildirimlerin yerine getirilmesi.</li>
                <li><strong>Raporlama ve Analiz:</strong> Gelecekteki etkinlikleri iyileştirmek amacıyla katılımcı profili hakkında isimsizleştirilmiş (anonim) istatistiksel veriler oluşturulması.</li>
            </ul>
            <h6>3. İşlenen Kişisel Veri Kategorileri ve Toplama Yöntemleri</h6>
            <p>Kişisel verileriniz, etkinlik kayıt formları (dijital veya basılı), e-posta, telefon görüşmeleri ve etkinlik sırasında gerçekleştirilen fotoğraf/video çekimleri gibi otomatik veya otomatik olmayan yöntemlerle toplanmaktadır. Bu kapsamda işlenen başlıca kişisel verileriniz şunlardır:</p>
            <ul><li><strong>Kimlik Bilgileri:</strong> Ad, Soyadı</li><li><strong>İletişim Bilgileri:</strong> E-posta Adresi, Telefon Numarası</li><li><strong>Görsel ve İşitsel Veriler:</strong> Etkinlik sırasında çekilen fotoğraf ve video kayıtları</li></ul>
            <h6>4. Kişisel Verilerin Aktarılabileceği Taraflar ve Aktarım Amaçları</h6>
            <p>Kişisel verileriniz, yukarıda belirtilen amaçların gerçekleştirilmesi doğrultusunda ve KVKK’nın 8. ve 9. maddelerine uygun olarak, gerekli güvenlik önlemleri alınarak aşağıdaki taraflarla paylaşılabilecektir:</p>
            <ul><li><strong>Tedarikçiler ve İş Ortakları:</strong> Etkinlik organizasyonu için hizmet alınan firmalar (örneğin, SMS/e-posta gönderim hizmeti sağlayan şirketler, ajanslar).</li><li><strong>Yetkili Kamu Kurum ve Kuruluşları:</strong> Yasal bir zorunluluk gereği talep edilmesi halinde, ilgili valilikler, emniyet müdürlükleri gibi kamu kurumları.</li><li><strong>Kamuoyu:</strong> Etkinliğe ait fotoğraf ve video kayıtları, Derneğin tanıtım faaliyetleri kapsamında sosyal medya hesapları aracılığıyla kamuoyu ile paylaşılabilir.</li></ul>
            <h6>5. Kişisel Veri Toplamanın Hukuki Sebebi</h6>
            <p>Kişisel verileriniz, KVKK’nın 5. maddesinde belirtilen hukuki sebeplere dayanılarak işlenmektedir: Bir sözleşmenin kurulması veya ifasıyla doğrudan doğruya ilgili olması (Etkinliğe kayıt, bu kapsamda bir katılım ilişkisi kurar).Veri sorumlusunun hukuki yükümlülüğünü yerine getirebilmesi için zorunlu olması (Resmi bildirimler).İlgili kişinin temel hak ve özgürlüklerine zarar vermemek kaydıyla, veri sorumlusunun meşru menfaatleri için veri işlenmesinin zorunlu olması (Tanıtım ve arşiv faaliyetleri).</p>
            <p>Fotoğraf ve video gibi özel nitelik taşıyabilecek verileriniz ile tanıtım/pazarlama amaçlı iletişimler için ise açık rızanızın alınması esastır. Etkinlik alanına girmeniz ve/veya kayıt formunu doldurmanız, bu metinde belirtilen görsel/işitsel verilerin işlenmesi ve paylaşılmasına ilişkin aydınlatılmış rızanız olarak kabul edilecektir.</p>
            <h6>6. İlgili Kişi Olarak Haklarınız (KVKK Madde 11)</h6>
            <p>Kişisel verisi işlenen herkes, KVKK'nın 11. maddesi uyarınca aşağıdaki haklara sahiptir:</p>
            <ol type="a">
                <li>Kişisel veri işlenip işlenmediğini öğrenme,</li>
                <li>Kişisel verileri işlenmişse buna ilişkin bilgi talep etme,</li>
                <li>Kişisel verilerin işlenme amacını ve bunların amacına uygun kullanılıp kullanılmadığını öğrenme,</li>
                <li>Yurt içinde veya yurt dışında kişisel verilerin aktarıldığı üçüncü kişileri bilme,</li>
                <li>Kişisel verilerin eksik veya yanlış işlenmiş olması hâlinde bunların düzeltilmesini isteme,</li>
                <li>KVKK’nın 7. maddesinde öngörülen şartlar çerçevesinde kişisel verilerin silinmesini veya yok edilmesini isteme,</li>
                <li>(d) ve (e) bentleri uyarınca yapılan işlemlerin, kişisel verilerin aktarıldığı üçüncü kişilere bildirilmesini isteme,</li>
                <li>İşlenen verilerin münhasıran otomatik sistemler vasıtasıyla analiz edilmesi suretiyle kişinin kendisi aleyhine bir sonucun ortaya çıkmasına itiraz etme,</li>
                <li>Kişisel verilerin kanuna aykırı olarak işlenmesi sebebiyle zarara uğraması hâlinde zararın giderilmesini talep etme.</li>
            </ol>
            <p>Yukarıda sayılan haklarınızı kullanmak için kimliğinizi teyit edici belgelerle birlikte talebinizi, yukarıda belirtilen adresimize yazılı olarak veya kayıtlı e-posta (KEP) adresi, güvenli elektronik imza, mobil imza ya da daha önce Derneğimize bildirdiğiniz ve sistemimizde kayıtlı bulunan e-posta adresinizi kullanarak birbulutolsamdernegi@gmail.com adresine iletebilirsiniz.</p>
            <p>Başvurunuz, niteliğine göre en kısa sürede ve en geç otuz (30) gün içinde ücretsiz olarak sonuçlandırılacaktır.</p>
            <p>Bu aydınlatma metni, değişen şartlara ve yasal düzenlemelere bağlı olarak güncellenebilir.</p>
            <p class="mt-4 text-end"><strong>Bir Bulut Olsam Derneği</strong></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
          </div>
        </div>
      </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // DEĞİŞİKLİK: API URL'si sizin verdiğiniz son ve güncel link ile değiştirildi.
      const API_URL = "https://script.google.com/macros/s/AKfycbwMBAiq0dx8u70zOBMtg3EPqLL659ZrBFWiuHVCYBMpQqLMJkib3isDoWFxgx3SMtHf/exec";

      const mevcutKullaniciToggle = document.getElementById("mevcutKullaniciToggle");
      const mevcutKullaniciAlan = document.getElementById("mevcutKullaniciAlan");
      const bilgiGetirBtn = document.getElementById("bilgiGetirBtn");
      const kayitFormu = document.getElementById("kayitFormu");
      const statusDiv = document.getElementById("status");
      const formSeparator = document.getElementById("formSeparator");

      // Düzeltilmiş ve sıralanmış JavaScript Fonksiyonları
      function etkinlikListesiniDoldur(etkinlikListesi) {
        const select = document.getElementById("etkinlik");
        if (etkinlikListesi) {
          etkinlikListesi.forEach(etkinlik => {
            const option = document.createElement("option");
            option.value = etkinlik[0];
            option.text = etkinlik[1];
            select.appendChild(option);
          });
        }
      }

      function kullaniciBilgileriniDoldur(kullaniciVerisi) {
        if (kullaniciVerisi) {
          document.getElementById("ad").value = kullaniciVerisi.ad;
          document.getElementById("soyad").value = kullaniciVerisi.soyad;
          document.getElementById("email").value = kullaniciVerisi.email;
          document.getElementById("telefon").value = kullaniciVerisi.telefon.replace(/\D/g, '').slice(-10);
          statusDiv.innerHTML = `<div class="alert alert-success">Bilgilerin bulundu! Etkinliği seçip kaydını tamamlayabilirsin.</div>`;
        } else {
          statusDiv.innerHTML = `<div class="alert alert-warning">Bu telefona ait kayıt bulamadık. Lütfen yeni kayıt ol.</div>`;
        }
      }

      function hataGoster(error) {
        statusDiv.innerHTML = `<div class="alert alert-danger">Bir şeyler ters gitti ve veriler çekilemedi. Lütfen sayfayı yenileyin. Hata: ${error.message}</div>`;
      }
      
      // Olay Dinleyicileri (Event Listeners)
      window.onload = function() {
        fetch(API_URL + "?action=getEtkinlikler")
          .then(response => {
            if (!response.ok) throw new Error('Network response was not ok.');
            return response.json();
          })
          .then(result => {
            if (result.success) {
              etkinlikListesiniDoldur(result.data);
            } else { throw new Error(result.message); }
          })
          .catch(hataGoster);
      };

      mevcutKullaniciToggle.addEventListener("click", e => {
        e.preventDefault();
        const isHidden = mevcutKullaniciAlan.style.display === "none" || mevcutKullaniciAlan.style.display === "";
        mevcutKullaniciAlan.style.display = isHidden ? "block" : "none";
        formSeparator.style.display = isHidden ? "block" : "none";
      });

      bilgiGetirBtn.addEventListener("click", () => {
        const telefonInput = document.getElementById("telefonGetir");
        if (!telefonInput.value) {
          statusDiv.innerHTML = `<div class="alert alert-warning">Lütfen bir telefon numarası gir.</div>`;
          return;
        }
        const telefon = "+90" + telefonInput.value;
        statusDiv.innerHTML = `<div class="alert alert-info">Bilgilerin aranıyor...</div>`;
        
        fetch(API_URL, {
          method: 'POST',
          mode: 'no-cors', // Bu satır bazen basit POST isteklerinde yardımcı olabilir.
          body: JSON.stringify({ action: 'kullaniciyiBul', telefon: telefon })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                kullaniciBilgileriniDoldur(result.data);
            } else { throw new Error(result.message || 'Kullanıcı bulunamadı.'); }
        })
        .catch(hataGoster);
      });

      kayitFormu.addEventListener("submit", e => {
        e.preventDefault();
        const formButton = kayitFormu.querySelector("button[type='submit']");
        formButton.disabled = true;
        formButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> KAYDEDİLİYOR...`;
        statusDiv.innerHTML = "";
        
        const formData = {
          etkinlik: document.getElementById("etkinlik").value,
          ad: document.getElementById("ad").value,
          soyad: document.getElementById("soyad").value,
          email: document.getElementById("email").value,
          telefon: "+90" + document.getElementById("telefon").value
        };
        
        fetch(API_URL, {
            method: 'POST',
            mode: 'no-cors', // Bu satır bazen basit POST isteklerinde yardımcı olabilir.
            body: JSON.stringify({ action: 'kayitEkle', formData: formData })
        })
        .then(response => response.json())
        .then(result => {
            if(result.success) {
                statusDiv.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
                kayitFormu.reset();
            } else { throw new Error(result.message); }
        })
        .catch(hataGoster)
        .finally(() => {
            formButton.disabled = false;
            formButton.innerHTML = "KAYIT OL";
        });
      });
    </script>
</body>
</html>
